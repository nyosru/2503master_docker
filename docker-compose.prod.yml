version: '3.8'

networks:
  laravel:
    external: true

#volumes:
#  cron_volume:
#    driver: local
#  portainer_data:

services:


  2503master:
    container_name: 2503master
    depends_on:
      db_mysql2:
        condition: service_healthy
    #    depends_on:
    #      - db_mysql2
    #    links:
    #      - db_mysql2:db
    networks:
      - laravel
    build:
      context: .
      dockerfile: docker.2503master.Dockerfile
    working_dir: ${FOLDER_2503MASTER_SERV}
    environment:
      - PHPGROUP=www-data
      - PHPUSER=www-data
      - FOLDER=${FOLDER_2503MASTER_SERV}
    restart: unless-stopped
    #    ports:
    #      - "9000:9001"
    expose:
      - 9000
    volumes:
      - '${FOLDER_2503MASTER}:${FOLDER_2503MASTER_SERV}'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      #      test: ["CMD", "curl", "-f", "https://процессмастер.рф/health"]
      #      test: ["CMD", "curl", "-f", "https://xn--80ajb0aifhffacm9b.xn--p1ai/health"]
      test: [ "CMD", "php", "artisan", "--version" ]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 512M
        reservations:
          memory: 256M

  2503master-queue:
    container_name: 2503master-queue
    depends_on:
      - db_mysql2
      - 2503master
    #    links:
    #      - db_mysql2:db
    networks:
      - laravel
    build:
      context: .
      dockerfile: docker.2503master.Dockerfile
    working_dir: ${FOLDER_2503MASTER_SERV}
    environment:
      - PHPGROUP=www-data
      - PHPUSER=www-data
      - FOLDER=${FOLDER_2503MASTER_SERV}
    #    restart: unless-stopped
    restart: always
    volumes:
      - '${FOLDER_2503MASTER}:${FOLDER_2503MASTER_SERV}'
    command: >
      sh -c "
        cd ${FOLDER_2503MASTER_SERV} &&
        php artisan queue:work --queue="default,notifications" --sleep=1 --tries=3
      "
    deploy:
      resources:
        limits:
          cpus: "0.30"
          memory: 512M
        reservations:
          memory: 256M

  2503master-scheduler:
    container_name: 2503master-scheduler
    depends_on:
      db_mysql2:
        condition: service_healthy
    #    depends_on:
    #      - db_mysql2
    #      - 2503master
    #    links:
    #      - db_mysql2:db
    networks:
      - laravel
    build:
      context: .
      dockerfile: docker.2503master.Dockerfile
    working_dir: ${FOLDER_2503MASTER_SERV}
    environment:
      - PHPGROUP=www-data
      - PHPUSER=www-data
      - FOLDER=${FOLDER_2503MASTER_SERV}
    #    restart: unless-stopped
    restart: always
    volumes:
      - '${FOLDER_2503MASTER}:${FOLDER_2503MASTER_SERV}'
    command: >
      sh -c "
        cd ${FOLDER_2503MASTER_SERV} &&
        while true; do php artisan schedule:run; sleep 60; done
      "
    deploy:
      resources:
        limits:
          cpus: "0.30"
          memory: 512M
        reservations:
          memory: 256M

